<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title><%=((typeof titulo === "undefined" || !titulo) ? "Agenda da Pós" : (titulo + " - Agenda da Pós")) %></title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet" />
    <link rel="stylesheet" href="<%- root %>/lib/bootstrap/css/bootstrap-1.0.28.min.css" />
    <link rel="stylesheet" href="<%- root %>/lib/font-awesome/css/font-awesome-1.0.2.min.css" />
    <link rel="stylesheet" href="<%- root %>/lib/paper-css/paper.css" />
    <link rel="stylesheet" href="<%- root %>/lib/bootstrap-year-calendar/css/bootstrap-year-calendar.css" />
    <script type="text/javascript" src="<%- root %>/lib/jquery/js/jquery-1.0.1.min.js"></script>
    <script type="text/javascript" src="<%- root %>/lib/bootstrap-year-calendar/js/bootstrap-year-calendar.js"></script>
    <script type="text/javascript" src="<%- root %>/lib/bootstrap-year-calendar/js/languages/bootstrap-year-calendar.pt.js"></script>

    <style type="text/css">
        #btnImprimir {
            position: fixed;
            left: 10px;
            top: 10px;
            box-shadow: 0 0.5mm 2mm rgba(0, 0, 0, 0.3);
        }

        @media print {
            body {
                background: #fff;
            }

            th.prev, th.next {
                color: #fff;
            }

            #btnImprimir {
                display: none;
            }
            
        }
        #legenda{
               background-color: #f2f2f2;
               margin-top: 20px;
               width: 50%;
               height: 300px;
            }
    </style>
</head>
<body class ="A4">
<section class="sheet" style="padding: 10px; margin: 0 auto">
    <div id="calendar" class="calendar"></div>
    <div class="container">
        <div class="row">
            <div class="col-md-6 ">
                <div id="legenda"> 
                    <% for (let i = 0; i < lista.length; i++) { %>
                        <p><%- lista[i].id_aula %>, <%= lista[i].nome_aula %></p>
                    <% } %>
                </div>
            </div>
            <div class="col-md-6 ">
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-primary" id="btnImprimir" onclick="window.print()"><i class="fa fa-print"></i> Imprimir / PDF</button>
</section>
<script type="text/javascript" src="<%- root %>/lib/bootstrap/js/bootstrap-1.0.1.min.js"></script>
<script type="text/javascript">
    "use strict";
    
    function gerarCalendario(){

        var aulas = <%- lista %>;
        console.log(aulas);


        function editEvent(event) {
            $('#event-modal input[name="event-index"]').val(event ? event.id : '');
            $('#event-modal input[name="event-name"]').val(event ? event.name : '');
            $('#event-modal input[name="event-location"]').val(event ? event.location : '');
            $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
            $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
            $('#event-modal').modal();
        }

        function deleteEvent(event) {
            var dataSource = $('#calendar').data('calendar').getDataSource();

            for(var i in dataSource) {
                if(dataSource[i].id == event.id) {
                    dataSource.splice(i, 1);
                    break;
                }
            }
            
            $('#calendar').data('calendar').setDataSource(dataSource);
        }

        function saveEvent() {
            var event = {
                id_aula: $('#event-modal input[name="id_aula"]').val(),
                id_sala: $('#event-modal input[name="id_sala"]').val(),
                id_prof: $('#event-modal input[name="id_prof"]').val(),
                id_turma: $('#event-modal input[name="id_turma"]').val(),
                nome_aula: $('#event-modal input[name="nome_aula"]').val(),
                desc_aula: $('#event-modal input[name="desc_aula"]').val(),
                // inicio_aula: $('#event-modal input[name="inicio_aula"]').val(),
                // termino_aula: $('#event-modal input[name="termino_aula"]').val(),
                startDate: $('#event-modal input[name="inicio_aula"]').val(),
                endDate: $('#event-modal input[name="termino_aula"]').val(),
                carga_horaria: $('#event-modal input[name="carga_horaria"]').val(),
                desc_sala: $('#event-modal input[name="desc_sala"]').val(),
                desc_turma: $('#event-modal input[name="desc_turma"]').val(),
                nome_prof: $('#event-modal input[name="nome_prof"]').val()
                // startDate: new Date(currentYear, 4, 28),
                // endDate: new Date(currentYear, 4, 29)
            }
            
            var dataSource = $('#calendar').data('calendar').getDataSource();

            if(event.id_aula) {
                for(var i in dataSource) {
                    if(dataSource[i].id_aula == event.id) {
                        dataSource[i].nome_aula = event.nome_aula;
                        dataSource[i].desc_aula = event.desc_aula;
                        dataSource[i].inicio_aula = event.inicio_aula;
                        dataSource[i].termino_aula = event.termino_aula;
                        dataSource[i].id_sala = event.id_sala;
                        dataSource[i].id_prof = event.id_prof;
                        dataSource[i].id_turma = event.id_turma;
                        dataSource[i].carga_horaria = event.carga_horaria;
                        dataSource[i].desc_sala = event.desc_sala;
                        dataSource[i].desc_turma = event.desc_turma;
                        dataSource[i].nome_prof = event.nome_prof;

                    }
                }
            }
            else
            {
                var newId = 0;
                for(var i in dataSource) {
                    if(dataSource[i].id_aula > newId) {
                        newId = dataSource[i].id_aula;
                    }
                }
                
                newId++;
                event.id_aula = newId;
            
                dataSource.push(event);
            }
            
            $('#calendar').data('calendar').setDataSource(dataSource);
            $('#event-modal').modal('hide');
        }
            $(function() {
                var currentYear = new Date().getFullYear();

                $('#calendar').calendar({
                    enableContextMenu: true,
                    enableRangeSelection: true,
                    contextMenuItems:[
                        {
                            text: 'Alterar',
                            click: editEvent
                        },
                        {
                            text: 'Delete',
                            click: deleteEvent
                        }
                    ],
                    selectRange: function(e) {
                        editEvent({ startDate: e.inicio_aula, endDate: e.termino_aula });
                    },
                    mouseOnDay: function(e) {
                        if(e.events.length > 0) {
                            var content = '';
                            
                            for(var i in e.events) {
                                content += '<div class="event-tooltip-content">'
                                                + '<div class="nome_aula" style="color:' + e.events[i].color + '">' + e.events[i].nome_aula + '</div>'
                                                + '<div class="desc_aula">' + e.events[i].desc_aula + '</div>'
                                            + '</div>';
                            }
                        
                            $(e.element).popover({
                                trigger: 'manual',
                                container: 'body',
                                html:true,
                                content: content
                            });
                            
                            $(e.element).popover('show');
                        }
                    },
                    mouseOutDay: function(e) {
                        if(e.events.length > 0) {
                            $(e.element).popover('hide');
                        }
                    },
                    dayContextMenu: function(e) {
                        $(e.element).popover('hide');
                    },
                    dataSource: [
                        {
                            id_aula: 0,
                            id_sala: 'Google I/O',
                            id_prof: 'Google I/O',
                            id_turma: 'San Francisco, CA',
                            nome_aula: 'San Francisco, CA',
                            desc_aula: 'San Francisco, CA',
                            nome_prof: 'San Francisco, CA',
                            carga_horaria: 'San Francisco, CA',
                            desc_sala: 'San Francisco, CA',
                            desc_turma: 'San Francisco, CA',
                            startDate: '2021-04-30',
                            // startDate: new Date(inicio_aula.getYear(), inicio_aula.getMonth(), inicio_aula.getDate()),
                            endDate: '2021-04-30'
                        },
                        {
                            id_aula: 1,
                            id_sala: 'oi',
                            id_prof: 'Google I/O',
                            id_turma: 'San Francisco, CA',
                            nome_aula: 'San Francisco, CA',
                            desc_aula: 'San Francisco, CA',
                            nome_prof: 'San Francisco, CA',
                            carga_horaria: 'San Francisco, CA',
                            desc_sala: 'San Francisco, CA',
                            desc_turma: 'San Francisco, CA',
                            startDate: new Date(currentYear, 5, 28),
                            endDate: new Date(currentYear, 5, 29)
                        }
                    ]
                });
                
                
                $('#save-event').click(function() {
                    saveEvent();
                });
            });
    }

    var turmaAtual = 0, anoAtual = <%- anoAtual %>;
    function atualizar() {
        var turma = parseInt($("#turma").val());
        var ano = (parseInt($("#ano").val()) || 0);

        if ((turmaAtual === turma && ano === anoAtual) || JsonWebApi.active)
            return;

        Notification.wait();

        JsonWebApi.get("<%- root %>/api/aula/listar", function (response) {
            if (response.success) {
                Notification.hide();
                turmaAtual = turma;
                anoAtual = ano;
            } else {
                Notification.error(response.value, true);
            }
        }, "id_turma", turma, "ano", ano);
    }
    // function montarPagina(aulas){
    //     var body = document.getElementById('body');
    //     body.innerHTML = "";

    //     for(var i = 0; i< aulas.length; i++){
    //         var nome_aula = aulas[i].nome_aula;
    //         var desc_aula = aulas[i].desc_aula;
    //         var desc_sala = aulas[i].desc_sala;
    //         var nome_prof = aulas[i].nome_prof;
    //         var inicio_aula = aulas[i].inicio_aula;
    //         var termino_aula = aulas[i].termino_aula;
    //         body.innerHTML +=  nome_aula +" - " + desc_aula+ "<br> Sala: " + desc_sala+ "<br> Professor: "+ nome_prof+ "<br>" +
    //         inicio_aula +" - "+ termino_aula + "<hr>";
    //     }
    // }
    gerarCalendario()

</script>
</body>
</html>
